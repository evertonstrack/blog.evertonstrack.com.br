<script>
  const settings = {
  posts: '/content.json',
  properties: ['title', 'tags'],
  limit: '10',
  noResults: '<p>Ops!<br/><small>Nenhum resultado encontrado. :(</small></p>',
  resultsTitle: '<h3>Resultados encontrados</h3>'
};

const searchPage = document.querySelector('.search');
const searchResultsContainer = document.querySelector('.search__results');
const searchResultsList = document.querySelector('.search__results-list');
const searchField = document.querySelector('.search-field');
const openSearchButton = document.querySelector('.open-search');
const closeSearchButton = document.querySelector('.close-search');
const sugestionButtons = document.querySelectorAll('.search-suggestion__button');

async function getPosts() {
  return fetch(settings.posts)
    .then(res => res.json())
    .catch(err => console.log(err));
}

function clearSearchResults(){
  searchResultsList.innerHTML = '';
}


function search(searchQuery){
  const matches = [];
  const { properties } = settings;

  console.log('searching...');
  settings.posts.forEach(post => {
    for(let index = 0; index < properties.length; index++) {
      if(post[properties[index]] !== undefined && post[properties[index]].toLowerCase().indexOf(searchQuery.toLowerCase()) !== -1){
        matches.push(post);

        // Caso encontre no post, nÃ£o verifica as outras propriedades
        index = properties.length;
      }
    }
  });

  return matches;
}

function writeMatches(results) {
  clearSearchResults();

  if(results.length){
    const template = results.map((result) => {
      return`<a class="search__results-item" href="${result.url}">${result.title}</a>`;
    }).join('');

    searchResultsList.innerHTML = `${settings.resultsTitle}${template}`;
  }else{
    searchResultsList.innerHTML =  settings.noResults;
  }
}

function openSearch() {
  openSearchButton.ariaExpanded = true;
  document.querySelector('body').classList.add('search-opened');
  location.hash = 'pesquisar';
  setTimeout(function(){ searchField.focus(); }, 500);
}

function closeSearch() {
  openSearchButton.ariaExpanded = false;
  document.querySelector('body').classList.remove('search-opened');
  location.hash = '';
  searchField.value = '';
  clearSearchResults();
}

function registerEvents(){

openSearchButton.addEventListener('click', openSearch);
closeSearchButton.addEventListener('click', closeSearch);

searchField.addEventListener('keyup', function() {
  if( searchField.value.length ) {
    writeMatches( search( searchField.value ));
  } else {
    clearSearchResults();
  }
});

searchField.addEventListener('search', function(){
  setTimeout(function(){
    if( !searchField.value.length ) {
      clearSearchResults()
    } else {
      searchField.blur();
    }
  }, 100);
});

sugestionButtons.forEach(suggestion => {
    suggestion.addEventListener('click', () => {
      searchField.value = suggestion.dataset.search;
      searchField.dispatchEvent(new Event('focus'));
      searchField.dispatchEvent(new KeyboardEvent('keyup',{'key':'a'}));
    });
  });
}

async function init() {
  const posts = await getPosts();
  settings.posts = posts;

  registerEvents();

  if( location.hash === '#pesquisar' ) {
    openSearch();
  }
}


// Inicia o script
init();

</script>
